<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spelling Assistant (Turbo Fix + AutoPlay+) </title>

  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-primary:#f3f4f6;
      --bg-card:#ffffff;
      --text-primary:#111827;
      --text-secondary:#4b5563;
      --muted:#6b7280;
      --accent-primary:#7c3aed;
      --accent-secondary:#8b5cf6;
      --accent-success:#10b981;
      --accent-danger:#ef4444;
      --accent-warn:#f59e0b;
      --border-light:#e5e7eb;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --shadow-soft: 0 4px 12px rgba(17,24,39,.06);
      --highlight-bg:#ede9fe;
      --highlight-border:#c4b5fd;
      --chip-bg:#f8fafc;
      --chip-border:#e2e8f0;
      --focus: 0 0 0 4px rgba(124,58,237,.15);
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body{
      font-family:'Work Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 400px at 20% 0%, rgba(124,58,237,.10), transparent 60%),
                  radial-gradient(900px 400px at 80% 0%, rgba(16,185,129,.08), transparent 60%),
                  var(--bg-primary);
      color:var(--text-primary);
      min-height:100vh;
      padding-bottom:3.25rem;
    }

    /* Loading Curtain */
    #curtain{
      position:fixed;
      inset:0;
      background: rgba(255,255,255,0.92);
      z-index:100;
      display:none;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      backdrop-filter: blur(6px);
    }
    #curtain.active{ display:flex; }
    .spinner{
      width:44px; height:44px;
      border:4px solid var(--accent-primary);
      border-top-color:transparent;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .header{
      position:sticky;
      top:0;
      z-index:50;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border-light);
      box-shadow: var(--shadow-soft);
    }
    .header-inner{
      max-width: 980px;
      margin:0 auto;
      padding: 0.9rem 1rem;
      display:flex;
      gap:1rem;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      gap:.75rem;
      align-items:center;
      min-width:0;
    }
    .brand h1{
      font-family:'Crimson Pro', serif;
      font-size:1.35rem;
      letter-spacing:.2px;
      color:var(--accent-primary);
      white-space:nowrap;
    }
    .sub{
      font-size:.82rem;
      color:var(--muted);
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .header-chips{
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.42rem .6rem;
      border-radius:999px;
      background: rgba(248,250,252,.9);
      border:1px solid var(--chip-border);
      color:var(--text-secondary);
      font-size:.78rem;
      font-weight:700;
    }
    .chip strong{ color:var(--accent-primary); }

    .container{
      max-width:980px;
      margin: 1.2rem auto;
      padding: 0 1rem;
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 1rem;
      align-items:start;
    }

    @media (max-width: 900px){
      .container{ grid-template-columns: 1fr; }
      .header-inner{ flex-direction:column; align-items:flex-start; }
      .header-chips{ justify-content:flex-start; }
    }

    .section-card{
      background: var(--bg-card);
      border:1px solid var(--border-light);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .section-header{
      padding: 1rem 1.1rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: .75rem;
      user-select:none;
    }
    .section-title{
      display:flex;
      align-items:center;
      gap:.6rem;
      font-weight:800;
      color:var(--text-primary);
      letter-spacing:.2px;
    }
    .toggle-icon{
      font-weight:900;
      color: var(--muted);
      transition: transform .25s ease;
    }
    .section-card.collapsed .toggle-icon{ transform: rotate(-90deg); }

    .section-content{
      padding: 1.1rem;
      border-top:1px solid var(--border-light);
    }
    .section-card.collapsed .section-content{
      display:none;
    }

    .word-list-input{
      width:100%;
      min-height: 190px;
      padding: 1rem;
      border: 2px solid var(--border-light);
      border-radius: 14px;
      font-size: 16px;
      line-height:1.65;
      background: #fbfbfd;
      color: var(--text-primary);
      resize: vertical;
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .word-list-input:focus{
      border-color: var(--accent-secondary);
      box-shadow: var(--focus);
    }

    .tools-bar{
      margin-top:.8rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .tool-btn, .tool-btn label{
      padding: .55rem .75rem;
      background: #fff;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      cursor:pointer;
      font-size: .86rem;
      font-weight:700;
      color: var(--text-secondary);
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      transition: transform .06s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .tool-btn:active{ transform: scale(.98); }
    .tool-btn:focus-visible{ outline:none; box-shadow: var(--focus); }

    .primary-btn{
      width:100%;
      margin-top: .9rem;
      padding: 1rem 1.1rem;
      background: linear-gradient(135deg, #10b981, #34d399);
      color:#fff;
      border:none;
      border-radius: 14px;
      cursor:pointer;
      font-size:1.05rem;
      font-weight: 900;
      box-shadow: 0 10px 20px rgba(16,185,129,.22);
      transition: transform .06s ease, filter .15s ease;
    }
    .primary-btn:active{ transform: scale(.99); }
    .primary-btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .primary-btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .panel{
      display:flex;
      flex-direction:column;
      gap: 1rem;
    }

    .status-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      background: linear-gradient(180deg, rgba(124,58,237,.06), rgba(255,255,255,.0));
      border: 1px solid rgba(124,58,237,.12);
      padding: .9rem 1rem;
      border-radius: 14px;
    }
    .counter{
      font-weight: 900;
      font-size: 1.05rem;
      color: var(--accent-primary);
    }
    .status-msg{
      font-size:.86rem;
      color: var(--text-secondary);
      font-weight: 700;
      text-align:right;
      min-width: 40%;
    }
    .substatus{
      display:block;
      margin-top:.1rem;
      font-size:.78rem;
      color: var(--muted);
      font-weight: 700;
    }

    .main-controls{
      display:grid;
      grid-template-columns: 1fr 1.6fr 1fr;
      gap: .75rem;
    }

    .ctrl-btn{
      padding: .95rem .85rem;
      border-radius: 14px;
      border: 2px solid var(--border-light);
      background: #fff;
      color: var(--text-primary);
      cursor:pointer;
      font-weight: 900;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:.2rem;
      box-shadow: var(--shadow-soft);
      transition: transform .06s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .ctrl-btn:active{ transform: scale(.99); }
    .ctrl-btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .ctrl-btn:disabled{ opacity:.5; cursor:not-allowed; }

    .btn-play{
      background: linear-gradient(135deg, #7c3aed, #8b5cf6);
      border-color: rgba(124,58,237,.35);
      color:#fff;
    }
    .btn-play.stop-mode{
      background: linear-gradient(135deg, #ef4444, #fb7185);
      border-color: rgba(239,68,68,.35);
    }
    .btn-play.repeat-mode{
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border-color: rgba(245,158,11,.35);
      color:#111827;
    }
    .btn-play.loading-mode{
      background: linear-gradient(135deg, #64748b, #94a3b8);
      border-color: rgba(100,116,139,.35);
    }

    .mini-controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: .6rem;
    }

    .mini-btn{
      padding: .75rem .7rem;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      background:#fff;
      cursor:pointer;
      font-weight: 900;
      color: var(--text-secondary);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.45rem;
    }
    .mini-btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .mini-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .mini-btn.primary{
      color:#fff;
      background: linear-gradient(135deg, #10b981, #34d399);
      border-color: rgba(16,185,129,.35);
    }
    .mini-btn.warn{
      color:#111827;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border-color: rgba(245,158,11,.35);
    }

    .settings-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .8rem;
    }
    @media (max-width: 520px){
      .main-controls{ grid-template-columns: 1fr 1.3fr 1fr; }
      .settings-grid{ grid-template-columns: 1fr; }
      .mini-controls{ grid-template-columns: 1fr; }
    }

    .setting-card{
      border: 1px solid var(--border-light);
      border-radius: 14px;
      padding: .85rem .85rem .9rem;
      background: #fff;
    }
    .setting-label{
      font-size: .78rem;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom:.55rem;
      display:flex;
      justify-content:space-between;
      gap:.6rem;
      align-items:baseline;
    }
    .setting-label small{
      color: var(--text-secondary);
      font-weight: 800;
    }
    .toggle-row{
      display:flex;
      gap: .35rem;
      flex-wrap:wrap;
    }
    .toggle-btn{
      flex:1;
      min-width: 84px;
      padding: .52rem .55rem;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: #fff;
      cursor:pointer;
      font-weight: 900;
      font-size: .82rem;
      color: var(--text-secondary);
    }
    .toggle-btn.active{
      background: rgba(139,92,246,.12);
      border-color: rgba(139,92,246,.40);
      color: var(--accent-primary);
    }
    .toggle-btn:disabled{ opacity:.45; cursor:not-allowed; }
    .toggle-btn:focus-visible{ outline:none; box-shadow: var(--focus); }

    .form-row{
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      padding:.65rem .7rem;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      background: #fff;
    }
    .field label{
      font-size: .84rem;
      font-weight: 900;
      color: var(--text-secondary);
    }
    input[type="number"], input[type="text"], select{
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding:.45rem .6rem;
      font-weight: 900;
      color: var(--text-primary);
      background: #fbfbfd;
      outline:none;
      min-width: 110px;
    }
    input[type="number"]:focus, input[type="text"]:focus, select:focus{
      border-color: var(--accent-secondary);
      box-shadow: var(--focus);
    }
    input[type="checkbox"]{
      transform: scale(1.15);
      accent-color: var(--accent-primary);
    }

    .answer-view{
      display:none;
      border-radius: 14px;
      padding: .6rem;
      max-height: 340px;
      overflow:auto;
      border: 1px solid var(--border-light);
      background: linear-gradient(180deg, rgba(124,58,237,.04), rgba(255,255,255,.0));
    }
    .answer-view.active{ display:block; }

    .peek-toolbar{
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      padding:.55rem;
      margin-bottom:.45rem;
      border-radius: 12px;
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(229,231,235,.9);
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(8px);
    }
    .peek-toolbar input{
      flex: 1;
      min-width: 160px;
    }
    .peek-toolbar .pill{
      padding:.5rem .65rem;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background:#fff;
      font-weight: 900;
      color: var(--text-secondary);
      cursor:pointer;
    }
    .peek-toolbar .pill.active{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.35);
      color: #065f46;
    }

    .sentence-item{
      padding: .7rem .75rem;
      margin-bottom: .35rem;
      border-radius: 12px;
      cursor:pointer;
      border: 1px solid transparent;
      background: rgba(255,255,255,.7);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.6rem;
    }
    .sentence-item:hover{
      border-color: rgba(139,92,246,.28);
    }
    .sentence-item.current{
      background: var(--highlight-bg);
      border-color: var(--highlight-border);
    }
    .sentence-left{
      min-width:0;
    }
    .sentence-original{
      font-weight: 800;
      color: var(--text-primary);
      line-height:1.45;
      word-break: break-word;
    }
    .sentence-meta{
      margin-top:.2rem;
      font-size: .75rem;
      color: var(--muted);
      font-weight: 800;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.14rem .5rem;
      border-radius: 999px;
      border:1px solid var(--border-light);
      background:#fff;
    }
    .badge.done{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
      color:#065f46;
    }
    .badge.star{
      border-color: rgba(245,158,11,.40);
      background: rgba(245,158,11,.12);
      color:#92400e;
    }
    .sentence-actions{
      display:flex;
      gap:.35rem;
      flex-shrink:0;
    }
    .icon-btn{
      border: 1px solid var(--border-light);
      background:#fff;
      border-radius: 10px;
      padding:.42rem .5rem;
      cursor:pointer;
      font-weight: 900;
      color: var(--text-secondary);
    }
    .icon-btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .icon-btn.active{
      border-color: rgba(124,58,237,.35);
      background: rgba(124,58,237,.10);
      color: var(--accent-primary);
    }

    .secondary-btn{
      width:100%;
      padding: .85rem 1rem;
      background:#fff;
      border: 2px solid var(--border-light);
      color: var(--text-secondary);
      font-weight: 900;
      border-radius: 14px;
      cursor:pointer;
    }
    .secondary-btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .secondary-btn:disabled{ opacity:.55; cursor:not-allowed; }

    .divider{
      height:1px;
      background: var(--border-light);
      margin: .8rem 0;
    }

    .hint{
      font-size: .82rem;
      color: var(--muted);
      font-weight: 700;
      line-height:1.5;
    }
    .hint kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .78rem;
      padding: .1rem .35rem;
      border-radius: 6px;
      background: #fff;
      border:1px solid var(--border-light);
      color: var(--text-secondary);
      font-weight: 900;
    }

    .version-footer{
      position:fixed;
      bottom: 10px;
      right: 14px;
      font-size:.72rem;
      color: var(--muted);
      opacity:.75;
      pointer-events:none;
    }
  </style>
</head>
<body>

  <div id="curtain" aria-live="polite" aria-busy="true">
    <div class="spinner" role="img" aria-label="Loading"></div>
    <p style="margin-top:1rem; font-weight:900; color:#374151;">AI Processing...</p>
  </div>

  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div>
          <h1>Spelling Assistant</h1>
          <div class="sub" id="headerSub">ÈªòÊõ∏Ê®°ÂºèÔºöAuto-Next + Repeat + ÈÄ≤Â∫¶‰øùÂ≠ò</div>
        </div>
      </div>
      <div class="header-chips" aria-label="Quick stats">
        <span class="chip">Mode: <strong id="chipLang">‚Äî</strong></span>
        <span class="chip">Done: <strong id="chipDone">0</strong></span>
        <span class="chip">Star: <strong id="chipStar">0</strong></span>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- LEFT: Editor -->
    <section class="section-card" id="inputSection">
      <div class="section-header" role="button" tabindex="0" aria-expanded="true" onclick="toggleInputSection()">
        <div class="section-title">üìù Content Editor</div>
        <div class="toggle-icon" aria-hidden="true">‚ñº</div>
      </div>

      <div class="section-content">
        <textarea id="wordListInput" class="word-list-input" placeholder="Ë≤º‰∏äÂÖßÂÆπÔºàÊØèË°åÁî® 1. / 1) / 1 ÈñãÈ†≠Ôºâ&#10;‰æãÔºö&#10;1. The quick brown fox, jumps over the lazy dog.&#10;2. She sells seashells by the seashore."></textarea>

        <div class="tools-bar" aria-label="Tools">
          <button class="tool-btn" type="button" onclick="loadExample('eng')">üá∫üá∏ Eng Example</button>
          <button class="tool-btn" type="button" onclick="loadExample('chi')">üá≠üá∞ Chi Example</button>

          <button class="tool-btn" type="button" onclick="autoNumberLines()">üî¢ Auto-number</button>
          <button class="tool-btn" type="button" onclick="trimAndNormalize()">üßπ Clean spacing</button>

          <label class="tool-btn" style="gap:.5rem;">
            üì∏ Camera (AI OCR)
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
          </label>
        </div>

        <button class="primary-btn" id="startBtn" onclick="startSpelling()">üöÄ Start Spelling</button>

        <div class="divider"></div>
        <div class="hint">
          Âø´Êç∑ÈçµÔºö<kbd>Space</kbd> Êí≠Êîæ/ÂÅúÊ≠¢Ôºå<kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> ‰∏ä/‰∏ã‰∏ÄÂè•Ôºå<kbd>P</kbd> PeekÔºå<kbd>D</kbd> DoneÔºå<kbd>F</kbd> Star
        </div>
      </div>
    </section>

    <!-- RIGHT: Player Panel -->
    <section class="section-card" id="controlSection">
      <div class="section-content panel">

        <!-- Peek -->
        <div id="peekView" class="answer-view" aria-label="Peek answers">
          <div class="peek-toolbar">
            <input id="peekSearch" type="text" placeholder="Search..." oninput="updatePeekView()" />
            <button class="pill" id="pillOnlyStar" type="button" onclick="togglePeekFilter('star')">‚≠ê Star</button>
            <button class="pill" id="pillOnlyTodo" type="button" onclick="togglePeekFilter('todo')">‚¨ú Êú™ Done</button>
          </div>
          <div id="peekList"></div>
        </div>

        <div class="status-bar" role="status" aria-live="polite">
          <div>
            <div class="counter" id="counterDisplay">0 / 0</div>
            <span class="substatus" id="subCounter">‚Äî</span>
          </div>
          <div class="status-msg" id="statusMessage">
            Waiting to start...
            <span class="substatus" id="statusDetail">‚Äî</span>
          </div>
        </div>

        <div class="main-controls">
          <button class="ctrl-btn" id="prevBtn" onclick="changeItem(-1)" disabled aria-label="Previous">
            <span style="font-size:1.45rem"‚èÆÔ∏è</span>
            <span style="font-size:.85rem; opacity:.9;">Prev</span>
          </button>

          <button class="ctrl-btn btn-play" id="centerBtn" onclick="handleCenterButton()" disabled aria-label="Play/Stop">
            <span class="icon" style="font-size:1.55rem">‚ñ∂Ô∏è</span>
            <span class="label">Play</span>
          </button>

          <button class="ctrl-btn" id="nextBtn" onclick="changeItem(1)" disabled aria-label="Next">
            <span style="font-size:1.45rem">‚è≠Ô∏è</span>
            <span style="font-size:.85rem; opacity:.9;">Next</span>
          </button>
        </div>

        <div class="mini-controls">
          <button class="mini-btn primary" id="doneBtn" type="button" onclick="toggleDoneCurrent()" disabled>‚úÖ Done</button>
          <button class="mini-btn warn" id="starBtn" type="button" onclick="toggleStarCurrent()" disabled>‚≠ê Star</button>
          <button class="mini-btn" id="peekBtn" onclick="togglePeek()" disabled>üëÅÔ∏è Peek</button>
        </div>

        <div class="settings-grid">

          <div class="setting-card">
            <div class="setting-label">
              <span>Speed</span>
              <small id="speedLabel">1.0x</small>
            </div>
            <div class="toggle-row">
              <button class="toggle-btn" type="button" onclick="setSpeed(0.75)" id="spd075">0.75x</button>
              <button class="toggle-btn active" type="button" onclick="setSpeed(1.0)" id="spd1">1.0x</button>
              <button class="toggle-btn" type="button" onclick="setSpeed(1.25)" id="spd125">1.25x</button>
            </div>
          </div>

          <div class="setting-card">
            <div class="setting-label">
              <span>Mode</span>
              <small id="modeLabel">WBW + Punc</small>
            </div>
            <div class="toggle-row">
              <button class="toggle-btn active" type="button" onclick="toggleWBW()" id="wbwBtn">WBW</button>
              <button class="toggle-btn active" type="button" onclick="togglePunc()" id="puncBtn">Read Punc.</button>
            </div>
          </div>

          <div class="setting-card">
            <div class="setting-label">
              <span>ÈªòÊõ∏ÊµÅÁ®ã</span>
              <small>Auto-Next / Repeat</small>
            </div>

            <div class="field" style="margin-bottom:.55rem;">
              <label for="autoNext">Auto-Next</label>
              <input id="autoNext" type="checkbox" onchange="setAutoNext(this.checked)" />
            </div>

            <div class="field" style="margin-bottom:.55rem;">
              <label for="repeatCount">Repeat Ê¨°Êï∏</label>
              <select id="repeatCount" onchange="setRepeatCount(parseInt(this.value,10))" aria-label="Repeat count">
                <option value="1">1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
              </select>
            </div>

            <div class="field">
              <label for="gapMs">ÈñìÈöî (Áßí)</label>
              <input id="gapMs" type="number" min="0.0" max="3.0" step="0.1" value="0.6" onchange="setGapSeconds(parseFloat(this.value))" />
            </div>
          </div>

          <div class="setting-card">
            <div class="setting-label">
              <span>È†ÜÂ∫è / Ê∫´Áøí</span>
              <small>Shuffle / Loop</small>
            </div>

            <div class="field" style="margin-bottom:.55rem;">
              <label for="shuffleToggle">Shuffle</label>
              <input id="shuffleToggle" type="checkbox" onchange="setShuffle(this.checked)" />
            </div>

            <div class="field" style="margin-bottom:.55rem;">
              <label for="loopOne">Loop Êú¨Âè•</label>
              <input id="loopOne" type="checkbox" onchange="setLoopOne(this.checked)" />
            </div>

            <div class="field">
              <label for="loopAll">Loop ÂÖ®ÈÉ®</label>
              <input id="loopAll" type="checkbox" onchange="setLoopAll(this.checked)" />
            </div>
          </div>

        </div>

        <button class="secondary-btn" id="exportBtn" type="button" onclick="exportProgress()" disabled>‚¨áÔ∏è Export Progress (JSON)</button>

        <div class="form-row">
          <button class="secondary-btn" id="importBtn" type="button" onclick="importProgressPrompt()">‚¨ÜÔ∏è Import Progress (JSON)</button>
          <button class="secondary-btn" id="resetBtn" type="button" onclick="resetProgressConfirm()" disabled>üóëÔ∏è Reset Progress</button>
        </div>

      </div>
    </section>

  </main>

  <div class="version-footer">v3.0 (Auto-Next + Repeat + Progress Save) ‚Äî ElevenLabs unchanged</div>

  <script>
    // =========================
    // State + Persistence
    // =========================
    const STORAGE_KEY = "spellingAssistant.v3.save";

    const state = {
      sentences: [],          // [{original, clean}]
      order: [],              // array of indices into sentences
      pos: 0,                 // position in order
      isPlaying: false,
      speed: 1.0,
      isWBW: true,
      readPunctuation: true,
      voice: 'Lily',
      audioCache: {},         // key -> url|"fallback"
      isInputVirgin: true,
      isPeeking: false,
      langMode: 'en',

      // Dictation flow
      autoNext: true,
      repeatCount: 1,
      gapMs: 600,
      loopOne: false,
      loopAll: false,
      shuffle: false,

      // Progress
      done: {},               // idx -> true
      star: {},               // idx -> true

      // Peek filters
      peekFilterStar: false,
      peekFilterTodo: false,
      peekSearch: ""
    };

    // Playback guards
    let currentAudioObj = null;
    let synth = window.speechSynthesis;
    let fetchTimeoutId = null;
    let playToken = 0; // increases every playCurrent; callbacks check token to avoid stale playback
    let scheduledTimer = null;

    const els = {
      inputSection: document.getElementById('inputSection'),
      input: document.getElementById('wordListInput'),
      curtain: document.getElementById('curtain'),

      peekView: document.getElementById('peekView'),
      peekList: document.getElementById('peekList'),
      peekSearch: document.getElementById('peekSearch'),
      pillOnlyStar: document.getElementById('pillOnlyStar'),
      pillOnlyTodo: document.getElementById('pillOnlyTodo'),

      counter: document.getElementById('counterDisplay'),
      subCounter: document.getElementById('subCounter'),
      status: document.getElementById('statusMessage'),
      statusDetail: document.getElementById('statusDetail'),

      centerBtn: document.getElementById('centerBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      peekBtn: document.getElementById('peekBtn'),
      doneBtn: document.getElementById('doneBtn'),
      starBtn: document.getElementById('starBtn'),

      wbwBtn: document.getElementById('wbwBtn'),
      puncBtn: document.getElementById('puncBtn'),
      speedLabel: document.getElementById('speedLabel'),
      modeLabel: document.getElementById('modeLabel'),

      speedBtns: {
        0.75: document.getElementById('spd075'),
        1.0: document.getElementById('spd1'),
        1.25: document.getElementById('spd125')
      },

      autoNext: document.getElementById('autoNext'),
      repeatCount: document.getElementById('repeatCount'),
      gapMs: document.getElementById('gapMs'),
      shuffleToggle: document.getElementById('shuffleToggle'),
      loopOne: document.getElementById('loopOne'),
      loopAll: document.getElementById('loopAll'),

      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      resetBtn: document.getElementById('resetBtn'),

      chipLang: document.getElementById('chipLang'),
      chipDone: document.getElementById('chipDone'),
      chipStar: document.getElementById('chipStar')
    };

    // =========================
    // Init
    // =========================
    function init(){
      loadSaved();
      if (!els.input.value.trim()) loadExample('eng');

      els.input.addEventListener('focus', () => {
        if (state.isInputVirgin) {
          els.input.value = '';
          state.isInputVirgin = false;
          saveNow();
        }
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        // avoid breaking typing in textarea/search
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        const isTyping = (tag === "textarea" || tag === "input");
        if (isTyping && e.key !== "Escape") return;

        if (e.code === "Space") { e.preventDefault(); if(!els.centerBtn.disabled) handleCenterButton(); }
        if (e.key === "ArrowLeft") { e.preventDefault(); if(!els.prevBtn.disabled) changeItem(-1); }
        if (e.key === "ArrowRight") { e.preventDefault(); if(!els.nextBtn.disabled) changeItem(1); }
        if (e.key.toLowerCase() === "p") { e.preventDefault(); if(!els.peekBtn.disabled) togglePeek(); }
        if (e.key.toLowerCase() === "d") { e.preventDefault(); if(!els.doneBtn.disabled) toggleDoneCurrent(); }
        if (e.key.toLowerCase() === "f") { e.preventDefault(); if(!els.starBtn.disabled) toggleStarCurrent(); }
        if (e.key === "Escape") { e.preventDefault(); if(state.isPlaying) stopAudio(true); }
      });

      setupOCR();
      syncUIFromState();
      updateStatsChips();
      updateDisplay();
    }

    function loadSaved(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const saved = JSON.parse(raw);

        // restore text
        if (typeof saved.inputText === "string") {
          els.input.value = saved.inputText;
          state.isInputVirgin = false;
        }

        // restore settings
        const s = saved.settings || {};
        state.speed = typeof s.speed === "number" ? s.speed : state.speed;
        state.isWBW = typeof s.isWBW === "boolean" ? s.isWBW : state.isWBW;
        state.readPunctuation = typeof s.readPunctuation === "boolean" ? s.readPunctuation : state.readPunctuation;

        state.autoNext = typeof s.autoNext === "boolean" ? s.autoNext : state.autoNext;
        state.repeatCount = Number.isInteger(s.repeatCount) ? s.repeatCount : state.repeatCount;
        state.gapMs = typeof s.gapMs === "number" ? s.gapMs : state.gapMs;
        state.shuffle = typeof s.shuffle === "boolean" ? s.shuffle : state.shuffle;
        state.loopOne = typeof s.loopOne === "boolean" ? s.loopOne : state.loopOne;
        state.loopAll = typeof s.loopAll === "boolean" ? s.loopAll : state.loopAll;

        // restore progress
        state.done = saved.done || {};
        state.star = saved.star || {};

        // restore last session (if any)
        if (saved.session && Array.isArray(saved.session.sentences)) {
          state.sentences = saved.session.sentences;
          state.order = Array.isArray(saved.session.order) ? saved.session.order : [];
          state.pos = Number.isInteger(saved.session.pos) ? saved.session.pos : 0;
          state.langMode = saved.session.langMode || state.langMode;

          // reset cache each load (URLs may expire)
          state.audioCache = {};
        }
      } catch(e){
        console.warn("Load saved failed", e);
      }
    }

    function saveNow(){
      try{
        const payload = {
          inputText: els.input.value,
          settings: {
            speed: state.speed,
            isWBW: state.isWBW,
            readPunctuation: state.readPunctuation,
            autoNext: state.autoNext,
            repeatCount: state.repeatCount,
            gapMs: state.gapMs,
            shuffle: state.shuffle,
            loopOne: state.loopOne,
            loopAll: state.loopAll
          },
          done: state.done,
          star: state.star,
          session: {
            sentences: state.sentences,
            order: state.order,
            pos: state.pos,
            langMode: state.langMode
          }
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch(e){
        console.warn("Save failed", e);
      }
    }

    // =========================
    // OCR (kept)
    // =========================
    function setupOCR() {
      document.getElementById('cameraInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (window.Poe && window.Poe.sendUserMessage) {
          toggleCurtain(true);
          const handlerId = "ocr-" + Date.now();

          window.Poe.registerHandler(handlerId, (result) => {
            if (result.responses[0].status === "complete") {
              els.input.value = result.responses[0].content;
              toggleCurtain(false);
              state.isInputVirgin = false;
              saveNow();
              setTimeout(() => alert("Text extracted!"), 80);
            }
          });

 ÔøΩ‚ñ∂
