<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Spelling Pro & Flashcards (Enhanced)</title>
<style>
:root{--primary:#4a90e2;--bg:#f4f7f6;--card:#fff;--text:#333;--accent:#ff6b6b;--green:#2ecc71;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{background:var(--primary);color:#fff;padding:15px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.1);flex-shrink:0;z-index:10}
h1{margin:0;font-size:1.2rem;font-weight:600}
.tabs{display:flex;justify-content:center;margin-top:10px}
.tab{padding:8px 16px;margin:0 5px;background:rgba(255,255,255,0.2);border-radius:20px;font-size:0.9rem;cursor:pointer;transition:0.3s}
.tab.active{background:#fff;color:var(--primary);font-weight:bold}
#main-container{flex:1;position:relative;overflow:hidden}
.view{position:absolute;top:0;left:0;width:100%;height:100%;overflow-y:auto;padding:20px;display:none;flex-direction:column;align-items:center}
.view.active{display:flex}
/* Card Styles */
.card-stack{position:relative;width:100%;max-width:400px;height:300px;margin:20px auto;perspective:1000px}
.flashcard{position:absolute;width:100%;height:100%;background:var(--card);border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);display:flex;flex-direction:column;justify-content:center;align-items:center;transition:transform 0.5s,opacity 0.5s;backface-visibility:hidden;padding:20px;text-align:center;cursor:pointer}
.flashcard.flipped{transform:rotateY(180deg)}
.card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center;border-radius:15px}
.card-back{transform:rotateY(180deg);background:#fdfdfd}
.word-text{font-size:2.5rem;font-weight:bold;margin-bottom:10px;color:var(--primary)}
.sentence-text{font-size:1rem;color:#666;margin-top:10px;font-style:italic;}
.card-controls{margin-top:20px;display:flex;gap:15px}
button{background:var(--primary);color:#fff;border:none;padding:12px 24px;border-radius:50px;font-size:1rem;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.2);transition:transform 0.1s}
button:active{transform:scale(0.95)}
button.secondary{background:#fff;color:var(--text);border:1px solid #ddd}
button.danger{background:var(--accent)}
button.success{background:var(--green)}
textarea{width:100%;max-width:500px;height:150px;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px;font-size:16px}
/* Spelling Mode */
.spelling-box{background:#fff;padding:20px;border-radius:15px;width:100%;max-width:500px;box-shadow:0 4px 10px rgba(0,0,0,0.05);text-align:center}
.input-group{margin:20px 0;position:relative}
.input-group input{width:100%;padding:15px;font-size:1.2rem;border:2px solid #eee;border-radius:10px;text-align:center;outline:none;transition:0.3s}
.input-group input:focus{border-color:var(--primary)}
.feedback{height:20px;font-size:0.9rem;margin-top:5px;font-weight:bold}
.feedback.correct{color:var(--green)}
.feedback.wrong{color:var(--accent)}
.progress-bar{width:100%;height:6px;background:#eee;border-radius:3px;margin:15px 0;overflow:hidden}
.progress-fill{height:100%;background:var(--green);width:0%;transition:width 0.3s}
.confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100}
/* Settings */
.settings-panel{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;width:100%;max-width:500px}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
.setting-row:last-child{border-bottom:none}
input[type="checkbox"]{transform:scale(1.3)}
/* Mic */
.mic-btn{font-size:1.5rem;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:10px auto;background:#f0f0f0;color:#555}
.mic-btn.listening{background:var(--accent);color:#fff;animation:pulse 1.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,0.4)}70%{box-shadow:0 0 0 15px rgba(255,107,107,0)}}
/* Curtain */
.curtain{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999;display:none;color:#333;display:flex;align-items:center;justify-content:center;flex-direction:column}
.curtain.active{display:flex}
.curtain-hole{width:200px;height:80px;background:transparent;border:2000px solid #000;position:absolute;transform:translate(-50%,-50%);top:50%;left:50%;pointer-events:none}
.curtain-text{color:#444;font-size:1.5rem;z-index:1000;margin-top:150px;font-weight:bold}
</style>
</head>
<body>

<header>
    <h1>Spelling Pro & Cards</h1>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('flashcard')">å­—å¡</div>
        <div class="tab" onclick="switchTab('spelling')">é»˜æ›¸</div>
        <div class="tab" onclick="switchTab('edit')">ç·¨è¼¯</div>
    </div>
</header>

<div id="main-container">
    <!-- FLASHCARD VIEW -->
    <div id="view-flashcard" class="view active">
        <div class="card-stack" onclick="flipCard()">
            <div class="flashcard" id="current-card">
                <div class="card-face card-front">
                    <div class="word-text" id="fc-word">Ready?</div>
                    <div style="font-size:0.8rem;color:#999">(é»æ“Šç¿»è½‰)</div>
                </div>
                <div class="card-face card-back">
                    <div class="word-text" id="fc-back-word">Ready?</div>
                    <div class="sentence-text" id="fc-sentence"></div>
                    <button class="mic-btn" onclick="event.stopPropagation();speakCurrent(true)">ğŸ”Š</button>
                </div>
            </div>
        </div>
        <div class="card-controls">
            <button class="danger" onclick="markWord(false)">é‚„è¦ç·´ ğŸ˜«</button>
            <button class="success" onclick="markWord(true)">è­˜èƒŒäº† ğŸ˜</button>
        </div>
        <div style="margin-top:20px;color:#888" id="fc-progress">0 / 0</div>
    </div>

    <!-- SPELLING VIEW -->
    <div id="view-spelling" class="view">
        <div class="settings-panel">
            <div class="setting-row">
                <span>æœ—è®€ä¾‹å¥ (Read Example)</span>
                <input type="checkbox" id="opt-example" checked>
            </div>
            <div class="setting-row">
                <span>è®€å‡ºæ¨™é» (Speak Punctuation)</span>
                <input type="checkbox" id="opt-punctuation">
            </div>
            <div class="setting-row">
                <span>è®€ä¸‰æ¬¡ (Read 3x)</span>
                <input type="checkbox" id="opt-repeat">
            </div>
            <div class="setting-row">
                <span>å·ç‡æ¨¡å¼ (Curtain)</span>
                <input type="checkbox" id="opt-curtain">
            </div>
        </div>

        <div class="spelling-box" id="spelling-ui" style="display:none">
            <div class="progress-bar"><div class="progress-fill" id="sp-bar"></div></div>
            <button class="mic-btn" onclick="speakCurrent(false)">ğŸ”Š</button>
            <div class="input-group">
                <input type="text" id="sp-input" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off" onkeyup="checkSpelling(event)">
                <div class="feedback" id="sp-feedback"></div>
            </div>
            <div style="display:flex;justify-content:space-between">
                <button class="secondary" onclick="giveHint()">æç¤º ğŸ’¡</button>
                <button onclick="checkAnswer()">æäº¤ âœ…</button>
            </div>
        </div>
        <button id="btn-start-sp" class="success" style="padding:15px 40px;font-size:1.2rem" onclick="startSpelling()">é–‹å§‹é»˜æ›¸</button>
    </div>

    <!-- EDIT VIEW -->
    <div id="view-edit" class="view">
        <h3>ç·¨è¼¯ç”Ÿå­—åº«</h3>
        <p style="font-size:0.8rem;color:#666">æ ¼å¼ï¼šç”Ÿå­— | ä¾‹å¥ (æ¯è¡Œä¸€å€‹)</p>
        <textarea id="edit-area" placeholder="Apple | I like apples."></textarea>
        <div class="card-controls">
            <button onclick="saveWords()">å„²å­˜</button>
            <button class="secondary" onclick="exportData()">å°å‡º</button>
            <button class="secondary" onclick="importData()">å°å…¥</button>
        </div>
        <div style="margin-top:20px;text-align:left;width:100%;max-width:500px">
            <h4>ç›®å‰å­—åº«:</h4>
            <ul id="word-list-display" style="padding-left:20px;color:#555"></ul>
        </div>
    </div>
</div>

<div id="curtain" class="curtain" onclick="toggleCurtain(false)">
    <div class="curtain-hole"></div>
    <div class="curtain-text">é»æ“Šç•«é¢é—œé–‰å·ç‡</div>
</div>

<canvas id="confetti" class="confetti"></canvas>

<script>
// --- DATA & STATE ---
// æ ¹æ“šè¦æ±‚ï¼Œé è¨­åŠ å…¥ 2å¥ä¸­æ–‡ã€2å¥è‹±æ–‡ï¼ŒåŒ…å«å®Œæ•´æ¨™é»ç¬¦è™Ÿ
let rawWords = [
    {w: "è˜‹æœ", s: "æˆ‘å–œæ­¡åƒè˜‹æœï¼Œå› ç‚ºå®ƒå¾ˆç”œã€‚"},
    {w: "åœ–æ›¸é¤¨", s: "åœ–æ›¸é¤¨å…§è«‹ä¿æŒå®‰éœï¼›ä¸è¦å¤§è²å–§å˜©ï¼"},
    {w: "Apple", s: "An apple a day keeps the doctor away."},
    {w: "Computer", s: "Can you turn on the computer, please?"}
];

let studyQueue = [];
let currentIndex = 0;
let isSpelling = false;
const synth = window.speechSynthesis;

// --- PUNCTUATION LOGIC (FROM YOUR DEMO) ---
const punctuationMap = {
    "ï¼Œ": "é€—è™Ÿ", "ã€‚": "å¥è™Ÿ", "ï¼Ÿ": "å•è™Ÿ", "ï¼": "æ„Ÿå˜†è™Ÿ",
    "ã€": "é “è™Ÿ", "ï¼›": "åˆ†è™Ÿ", "ï¼š": "å†’è™Ÿ", "ã€Œ": "é–‹å¼•è™Ÿ", "ã€": "é—œå¼•è™Ÿ",
    ",": "Comma", ".": "Full Stop", "?": "Question Mark", "!": "Exclamation Mark"
};

function convertPunctuationToText(text) {
    let processedText = text;
    for (let symbol in punctuationMap) {
        const textName = punctuationMap[symbol];
        // å…¨åŸŸæ›¿æ›ï¼Œä¸¦åœ¨å‰å¾ŒåŠ ç©ºæ ¼ä»¥ç¢ºä¿åœé “è‡ªç„¶
        processedText = processedText.split(symbol).join(` ${textName} `);
    }
    return processedText;
}

function generateSpeechText(item, settings) {
    let textToSpeak = item.w; // å…ˆè®€ç”Ÿå­—
    
    // å¦‚æœæ˜¯é»˜æ›¸æ¨¡å¼ä¸”é–‹å•Ÿäº†ä¾‹å¥
    if (settings.readExample && item.s) {
        let sentenceContent = item.s;
        if (settings.speakPunctuation) {
            sentenceContent = convertPunctuationToText(sentenceContent);
        }
        // ç”Ÿå­— ... ä¾‹å¥
        textToSpeak += " ... " + sentenceContent;
    }
    return textToSpeak;
}

// --- CORE FUNCTIONS ---
function init() {
    loadFromStorage();
    updateEditArea();
    updateFlashcardUI();
}

function switchTab(tab) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('view-' + tab).classList.add('active');
    document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
    if(tab === 'flashcard') updateFlashcardUI();
}

// --- FLASHCARD LOGIC ---
function updateFlashcardUI() {
    if (rawWords.length === 0) return;
    const item = rawWords[currentIndex % rawWords.length];
    document.getElementById('fc-word').innerText = item.w;
    document.getElementById('fc-back-word').innerText = item.w;
    document.getElementById('fc-sentence').innerText = item.s || "";
    document.getElementById('current-card').classList.remove('flipped');
    document.getElementById('fc-progress').innerText = `${(currentIndex % rawWords.length) + 1} / ${rawWords.length}`;
}

function flipCard() {
    document.getElementById('current-card').classList.toggle('flipped');
    // ç¿»åˆ°èƒŒé¢æ™‚è‡ªå‹•è®€ä¸€æ¬¡ (ä¸è®€æ¨™é»ï¼Œåªè®€è‡ªç„¶èªå¥)
    if(document.getElementById('current-card').classList.contains('flipped')) {
        speakText(rawWords[currentIndex % rawWords.length].w); 
    }
}

function markWord(known) {
    // ç°¡å–®çš„å¾ªç’°é‚è¼¯
    currentIndex++;
    updateFlashcardUI();
}

// --- SPELLING LOGIC ---
function startSpelling() {
    if (rawWords.length === 0) { alert("è«‹å…ˆåŠ å…¥ç”Ÿå­—ï¼"); return; }
    isSpelling = true;
    studyQueue = [...rawWords].sort(() => Math.random() - 0.5); // Shuffle
    currentIndex = 0;
    
    document.getElementById('btn-start-sp').style.display = 'none';
    document.getElementById('spelling-ui').style.display = 'block';
    
    if(document.getElementById('opt-curtain').checked) toggleCurtain(true);
    
    loadNextSpelling();
}

function loadNextSpelling() {
    if (currentIndex >= studyQueue.length) {
        finishSpelling();
        return;
    }
    document.getElementById('sp-input').value = '';
    document.getElementById('sp-feedback').innerText = '';
    document.getElementById('sp-input').focus();
    updateProgressBar();
    
    // å»¶é²ä¸€é»è®€ï¼Œè®“UIå…ˆæº–å‚™å¥½
    setTimeout(() => speakCurrent(false), 500);
}

function speakCurrent(forceSimple = false) {
    if (rawWords.length === 0) return;
    
    let item = isSpelling ? studyQueue[currentIndex] : rawWords[currentIndex % rawWords.length];
    
    // ç²å–è¨­å®š
    const settings = {
        readExample: document.getElementById('opt-example').checked,
        speakPunctuation: document.getElementById('opt-punctuation').checked
    };

    // å¦‚æœæ˜¯å¼·åˆ¶ç°¡å–®æ¨¡å¼ (FlashcardèƒŒé¢) æˆ–è€…æ²’æœ‰ä¾‹å¥ï¼Œå°±åªè®€å­—
    let text = "";
    if (forceSimple || !isSpelling) {
        text = item.w;
    } else {
        // ä½¿ç”¨ä½ çš„é‚è¼¯ç”Ÿæˆæ–‡å­—
        text = generateSpeechText(item, settings);
    }

    const u = new SpeechSynthesisUtterance(text);
    // ç°¡å–®æª¢æ¸¬èªè¨€
    u.lang = /[\u4e00-\u9fa5]/.test(item.w) ? 'zh-HK' : 'en-US';
    u.rate = 0.9;
    
    synth.cancel();
    synth.speak(u);
    
    // è®€ä¸‰æ¬¡è¨­å®š
    if (isSpelling && document.getElementById('opt-repeat').checked && !forceSimple) {
        setTimeout(() => synth.speak(u), 2500);
        setTimeout(() => synth.speak(u), 5000);
    }
}

function checkSpelling(e) {
    if (e.key === 'Enter') checkAnswer();
}

function checkAnswer() {
    const input = document.getElementById('sp-input').value.trim();
    const target = studyQueue[currentIndex].w;
    const fb = document.getElementById('sp-feedback');
    
    if (input.toLowerCase() === target.toLowerCase()) {
        fb.innerText = "æ­£ç¢ºï¼ğŸ‰";
        fb.className = "feedback correct";
        fireConfetti();
        setTimeout(() => {
            currentIndex++;
            loadNextSpelling();
        }, 1000);
    } else {
        fb.innerText = "å†è©¦ä¸€æ¬¡...";
        fb.className = "feedback wrong";
        speakCurrent(true); // è®€éŒ¯æ™‚åªè®€å–®å­—
    }
}

function giveHint() {
    const target = studyQueue[currentIndex].w;
    const input = document.getElementById('sp-input');
    input.value = target.substring(0, input.value.length + 1);
    input.focus();
}

function finishSpelling() {
    isSpelling = false;
    document.getElementById('spelling-ui').style.display = 'none';
    document.getElementById('btn-start-sp').style.display = 'block';
    alert("é»˜æ›¸å®Œæˆï¼å¤ªæ£’äº†ï¼");
}

function updateProgressBar() {
    const pct = (currentIndex / studyQueue.length) * 100;
    document.getElementById('sp-bar').style.width = pct + '%';
}

function toggleCurtain(show) {
    const c = document.getElementById('curtain');
    if(show) {
        c.classList.add('active'); 
        // ç¢ºä¿æ´åœ¨è¼¸å…¥æ¡†é™„è¿‘ (ç°¡å–®ç½®ä¸­)
    } else {
        c.classList.remove('active');
    }
}

// --- DATA MANAGEMENT ---
function updateEditArea() {
    // å°‡ç‰©ä»¶è½‰æ›å›æ–‡å­—æ ¼å¼é¡¯ç¤º
    const text = rawWords.map(i => `${i.w} | ${i.s || ''}`).join('\n');
    document.getElementById('edit-area').value = text;
    renderList();
}

function saveWords() {
    const text = document.getElementById('edit-area').value;
    const lines = text.split('\n');
    rawWords = [];
    lines.forEach(line => {
        if(line.trim()) {
            // è§£æ "Word | Sentence" æ ¼å¼
            const parts = line.split('|');
            const w = parts[0].trim();
            const s = parts[1] ? parts[1].trim() : "";
            if(w) rawWords.push({w, s});
        }
    });
    localStorage.setItem('sp_words_v2', JSON.stringify(rawWords));
    alert("å„²å­˜æˆåŠŸï¼");
    renderList();
    currentIndex = 0;
    updateFlashcardUI();
}

function loadFromStorage() {
    const data = localStorage.getItem('sp_words_v2');
    if (data) {
        rawWords = JSON.parse(data);
    }
}

function renderList() {
    const ul = document.getElementById('word-list-display');
    ul.innerHTML = rawWords.map(i => `<li><b>${i.w}</b> <small>${i.s ? '('+i.s+')' : ''}</small></li>`).join('');
}

function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rawWords));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "spelling_data.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.readAsText(file,'UTF-8');
        reader.onload = readerEvent => {
            try {
                rawWords = JSON.parse(readerEvent.target.result);
                saveWords(); // Save and refresh
                updateEditArea();
            } catch(e) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
        }
    }
    input.click();
}

// --- UTILS (Confetti) ---
function fireConfetti() {
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particles = [];
    for(let i=0; i<100; i++) particles.push({x:canvas.width/2, y:canvas.height/2, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, c:`hsl(${Math.random()*360},100%,50%)`});
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach((p,i) => {
            p.x+=p.vx; p.y+=p.vy; p.vy+=0.2;
            ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,5,5);
            if(p.y>canvas.height) particles.splice(i,1);
        });
        if(particles.length) requestAnimationFrame(draw);
    }
    draw();
}

// Start
init();
</script>
</body>
</html>
