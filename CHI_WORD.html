<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­æ–‡é–ƒå¡ v2.1 (iPad å°ˆæ¥­ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Serif+HK:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #e0f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #37474f;
            --text-secondary: #78909c;
            
            --accent: #ff7043;
            --btn-speak: #42a5f5;
            --btn-pause: #ffca28;
            --btn-master: #66bb6a;
            --danger: #ef5350;
            
            --card-border: #b2ebf2;
            --font-ui: 'M PLUS Rounded 1c', sans-serif;
            --font-learn: 'Kaiti TC', 'STKaiti', 'BiaoKai', 'Noto Serif HK', serif;
            
            --progress-color: #c8e6c9; /* ç†Ÿç·´åº¦èƒŒæ™¯è‰² */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        /* --- ä½ˆå±€ç³»çµ± (iPad å„ªåŒ–) --- */
        .main-layout {
            display: flex; gap: 20px; height: 100%; width: 100%;
            position: relative; z-index: 10;
        }

        /* å·¦å´/ä¸Šæ–¹ï¼šåˆ—è¡¨å€ */
        .sidebar {
            flex: 0 0 380px; display: flex; flex-direction: column; gap: 15px;
            height: 100%; overflow: hidden; transition: all 0.3s;
        }

        /* å³å´/ä¸‹æ–¹ï¼šå­¸ç¿’å€ */
        .learning-area {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; position: relative;
            background: rgba(255,255,255,0.3); border-radius: 24px; padding: 10px;
        }

        /* é¢æ¿æ¨£å¼ */
        .panel {
            background: var(--bg-secondary); padding: 12px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid var(--card-border);
            display: flex; flex-direction: column; min-height: 0; position: relative;
        }
        .panel-words { flex: 3; }     
        .panel-mastered { flex: 2; border-color: #a5d6a7; background-color: #f1f8e9; }  

        .panel-title {
            font-size: 1.1rem; color: var(--text-primary); font-weight: 800;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }

        /* è©èªç¶²æ ¼ */
        .word-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            overflow-y: auto; padding: 2px; align-content: start; flex: 1;
        }

        /* è©èªå¡ç‰‡ */
        .word-tag {
            background: #f5f5f5; aspect-ratio: 1 / 1; border-radius: 12px;
            border: 2px solid transparent; cursor: pointer; position: relative;
            transition: transform 0.1s, border-color 0.2s;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-family: var(--font-learn);
            color: #333; font-weight: bold; padding: 2px; overflow: hidden;
        }
        .word-tag:active { transform: scale(0.95); }
        
        /* ç•¶å‰é¸ä¸­ */
        .word-tag.active { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(255, 112, 67, 0.3);
            z-index: 2;
        }

        /* ç†Ÿç·´åº¦èƒŒæ™¯ (ç”±ä¸‹è€Œä¸Š) */
        .word-tag-bg {
            position: absolute; bottom: 0; left: 0; width: 100%; background: var(--progress-color);
            z-index: 0; transition: height 0.5s ease; opacity: 0.6; pointer-events: none;
        }
        
        /* è©èªæ–‡å­—å±¤ */
        .word-tag-content { position: relative; z-index: 1; width: 100%; }
        .word-tag span { line-height: 1.1; width: 100%; display: block; }
        
        /* å­—é«”å¤§å°é©é… */
        .len-1 span, .len-2 span { font-size: 1.8rem; }
        .len-3 span { font-size: 1.3rem; }
        .len-4 span { font-size: 1.4rem; display: flex; flex-direction: column; }
        .len-4 span i { font-style: normal; width: 100%; display: block; line-height: 1.1; }
        .len-long span { font-size: 0.9rem; word-break: break-all; }

        /* å·¦ä¸‹è§’æ¬¡æ•¸ (Views) */
        .view-count {
            position: absolute; bottom: 2px; left: 4px; font-size: 0.65rem;
            color: #78909c; font-family: var(--font-ui); font-weight: 700; z-index: 2;
        }

        /* æ–°å¢æŒ‰éˆ• (+) */
        .add-tag {
            background: #eceff1; color: #90a4ae; font-size: 2.5rem; border: 2px dashed #cfd8dc;
        }
        .add-tag:hover { background: #fff; color: var(--accent); border-color: var(--accent); }
        
        /* æ ¼å…§è¼¸å…¥æ¡† */
        .grid-input {
            width: 100%; height: 100%; border: none; background: #fff;
            text-align: center; font-size: 1.2rem; font-family: var(--font-learn);
            outline: none; border-radius: 10px; color: var(--text-primary); padding: 0;
        }

        /* å­¸ç¿’å¡ç‰‡å€ */
        .progress-container { width: 100%; max-width: 500px; margin-bottom: 15px; text-align: center; }
        .progress-bar { height: 8px; background: #eceff1; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ffca28, #ffa000); transition: width 0.3s; }
        .progress-text { font-size: 0.9rem; font-weight: bold; color: var(--text-secondary); margin-top: 5px; }

        .flashcard {
            background: rgba(255, 255, 255, 0.95);
            width: 100%; max-width: 700px; flex: 1; max-height: 50vh;
            border-radius: 24px; border: 4px solid var(--card-border);
            box-shadow: 0 8px 0 rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: 20px; position: relative; z-index: 20;
        }
        
        .word-display {
            font-size: 8rem; font-weight: 700; color: var(--text-primary);
            text-align: center; line-height: 1.2; font-family: var(--font-learn);
            padding: 10px; width: 100%; word-break: break-all;
        }

        .status-badge {
            position: absolute; top: 15px; padding: 6px 16px; border-radius: 20px;
            font-weight: bold; font-size: 1.2rem; opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .status-waiting { background: #fff9c4; color: #f9a825; opacity: 1; border: 2px solid #fff59d; }
        .status-reading { background: #e3f2fd; color: #1565c0; opacity: 1; border: 2px solid #bbdefb; }
        .status-paused { background: #ffe0b2; color: #e65100; opacity: 1; border: 2px solid #ffcc80; }

        /* æ§åˆ¶æŒ‰éˆ• */
        .controls-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 600px; z-index: 20;
        }

        .big-btn {
            border: none; padding: 16px; border-radius: 18px; font-size: 1.2rem;
            font-weight: 800; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.1s; position: relative; top: 0;
            font-family: var(--font-ui); box-shadow: 0 5px 0 rgba(0,0,0,0.15);
        }
        .big-btn:active { top: 5px; box-shadow: none !important; }
        .big-btn:disabled { background: #cfd8dc !important; box-shadow: none !important; color: #fff; cursor: not-allowed; top: 0; }

        .btn-speak { background: var(--btn-speak); box-shadow: 0 5px 0 #1e88e5; grid-column: 1 / 2; }
        .btn-speak.paused { background: var(--btn-pause); box-shadow: 0 5px 0 #ffb300; }
        .btn-master { background: var(--btn-master); box-shadow: 0 5px 0 #43a047; grid-column: 2 / 3; }
        
        .nav-btn {
            background: #fff; color: var(--text-primary); border: 2px solid #cfd8dc;
            box-shadow: 0 5px 0 #b0bec5; font-size: 1rem; padding: 12px;
        }

        /* é–‹é—œå€åŸŸ */
        .toggles-area {
            margin-top: 15px; display: flex; gap: 20px; background: rgba(255,255,255,0.6);
            padding: 10px 20px; border-radius: 16px; flex-wrap: wrap; justify-content: center;
        }
        .toggle-item { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .toggle-item input { accent-color: var(--accent); width: 22px; height: 22px; }

        /* åº•éƒ¨åŠŸèƒ½åˆ— */
        .parents-bar {
            margin-top: auto; display: flex; gap: 10px; justify-content: center; padding-top: 10px;
        }
        .mini-btn {
            padding: 10px 16px; font-size: 0.9rem; border-radius: 10px; border: 1px solid #cfd8dc;
            background: #fff; cursor: pointer; font-weight: bold; color: #546e7a;
        }

        /* Modal å„ªåŒ– */
        .custom-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 24px;
            padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.25);
            text-align: center; display: flex; flex-direction: column;
        }
        
        .import-textarea {
            width: 100%; height: 40vh; /* åŠ é«˜ */
            border: 2px solid #cfd8dc; border-radius: 12px;
            padding: 15px; font-size: 1.1rem; resize: none; font-family: var(--font-ui);
            margin: 10px 0;
        }
        
        .modal-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: bold; font-size: 0.95rem; cursor: pointer; }
        .btn-save { background: var(--accent); color: white; }
        .btn-no { background: #eceff1; color: #455a64; }

        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        .setting-input { width: 70px; padding: 8px; border-radius: 10px; border: 1px solid #cfd8dc; text-align: center; font-size: 1.1rem; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
            border-radius: 40px; font-weight: bold; font-size: 1.1rem; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }

        /* æ‰¹é‡åˆªé™¤æ¨¡å¼æ¨£å¼ */
        .delete-mode-active .panel-mastered { border-color: var(--danger); box-shadow: 0 0 0 2px var(--danger) inset; }
        .del-checkbox {
            position: absolute; top: 4px; right: 4px; width: 24px; height: 24px;
            accent-color: var(--danger); z-index: 10;
        }

        /* ç‰¹æ•ˆå±¤ */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2500; }
        .particle { position: absolute; pointer-events: none; animation: fadeOut 1s forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        /* --- iPad ç›´å±é©é… (Portrait) --- */
        @media (orientation: portrait) {
            .main-layout { flex-direction: column; }
            .sidebar { flex: none; height: 40vh; width: 100%; }
            .word-grid { grid-template-columns: repeat(5, 1fr); }
            .learning-area { height: 60vh; border-radius: 24px 24px 0 0; }
            .flashcard { max-height: 35vh; }
            .word-display { font-size: 6rem; }
        }

        /* --- æ‰‹æ©Ÿé©é… --- */
        @media (max-width: 600px) {
            .word-grid { grid-template-columns: repeat(4, 1fr); }
            .word-display { font-size: 5rem; }
            .big-btn { font-size: 1rem; padding: 12px; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="main-layout">
        <!-- å·¦/ä¸Šï¼šåˆ—è¡¨ -->
        <div class="sidebar">
            <div class="panel panel-words">
                <div class="panel-title">
                    <span>ğŸ“– è©èªè¡¨ <small id="wordCount">(0)</small></span>
                </div>
                <div class="word-grid" id="wordList">
                    <!-- JS æœƒåœ¨é€™è£¡æ’å…¥ "+" æŒ‰éˆ•å’Œè©èª -->
                </div>
            </div>

            <div class="panel panel-mastered" id="masteredPanel">
                <div class="panel-title">
                    <span>ğŸ† å·²å­¸è­˜ <small id="masteredCount">(0)</small></span>
                    <div id="deleteControls" style="display:none; gap:8px;">
                        <button class="mini-btn" onclick="toggleSelectAll()">å…¨é¸</button>
                        <button class="mini-btn" style="color:white; background:var(--danger); border:none;" onclick="confirmBatchDelete()">åˆªé™¤</button>
                        <button class="mini-btn" onclick="exitDeleteMode()">å–æ¶ˆ</button>
                    </div>
                </div>
                <div class="word-grid" id="masteredList"></div>
                <div style="text-align:center; font-size:0.75rem; color:#90a4ae; margin-top:5px;">(é•·æŒ‰è©èªå¯åˆªé™¤)</div>
            </div>

            <div class="parents-bar">
                <button class="mini-btn" onclick="openEditModal()">ğŸ“ ç·¨è¼¯</button>
                <button class="mini-btn" onclick="exportData()">ğŸ“¤ å°å‡º</button>
                <button class="mini-btn" onclick="openSettingsModal()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <!-- å³/ä¸‹ï¼šå­¸ç¿’ -->
        <div class="learning-area">
            <div class="progress-container">
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
                <div class="progress-text" id="progressText">æº–å‚™é–‹å§‹</div>
            </div>

            <div class="flashcard" id="flashcard">
                <div class="status-badge" id="statusBadge">ğŸ‘€ æº–å‚™</div>
                <div class="word-display" id="currentWord">...</div>
            </div>

            <div class="controls-grid">
                <button class="big-btn btn-speak" id="speakBtn" onclick="toggleSpeak()">
                    ğŸ”Š æœ—è®€
                </button>
                <button class="big-btn btn-master" id="masteredBtn" onclick="handleMasteryClick(event)">
                    âœ… æˆ‘è­˜å’—å–‡ï¼
                </button>
                
                <button class="big-btn nav-btn" id="prevBtn" onclick="previousWord()">ğŸ‘ˆ ä¸Šä¸€å€‹</button>
                <button class="big-btn nav-btn" id="nextBtn" onclick="nextWord()">ä¸‹ä¸€å€‹ ğŸ‘‰</button>
            </div>

            <div class="toggles-area">
                <label class="toggle-item">
                    <input type="checkbox" id="autoPlayNext">
                    â–¶ï¸ è‡ªå‹•æ¨¡å¼
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="repeatThreeTimes">
                    ğŸ” è®€ä¸‰æ¬¡
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="randomOrder">
                    ğŸ”€ æ´—ç‰Œæ¨¡å¼
                </label>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤ºè¨Šæ¯</div>

    <!-- ç·¨è¼¯è¦–çª— -->
    <div id="importModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ ç·¨è¼¯æ‰€æœ‰è©èª</div>
            <p style="font-size:0.9rem; color:#666;">ç›´æ¥ä¿®æ”¹æˆ–è²¼ä¸Šæ–°è©èªã€‚<br><small>æ³¨æ„ï¼šä¿å­˜å¾Œæœƒé‡ç½®å­¸ç¿’æ¬¡æ•¸ã€‚</small></p>
            <textarea id="importTextarea" class="import-textarea"></textarea>
            <div class="modal-actions">
                <button class="modal-btn btn-save" onclick="saveEdit()">ğŸ’¾ ä¿å­˜</button>
                <button class="modal-btn btn-no" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šè¦–çª— -->
    <div id="settingsModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ è¨­å®š</div>
            
            <div class="setting-row">
                <div class="setting-label">è‡ªå‹•æ¨¡å¼å€’æ•¸ (ç§’)</div>
                <input type="number" id="settingAutoDelay" class="setting-input" value="4" min="1" max="10">
            </div>
            
            <div class="setting-row">
                <div class="setting-label">é‡è¤‡æœ—è®€é–“éš” (ç§’)</div>
                <input type="number" id="settingRepeatDelay" class="setting-input" value="2" min="1" max="5">
            </div>

            <div class="setting-row">
                <div class="setting-label">ã€Œæˆ‘è­˜å’—å–‡ã€é–€æª» (æ¬¡)</div>
                <input type="number" id="settingMasteryThreshold" class="setting-input" value="1" min="1" max="20">
            </div>

            <div class="modal-actions">
                <button class="modal-btn btn-save" onclick="saveSettings()">ğŸ’¾ ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // æ•¸æ“šçµæ§‹
        let words = [];
        let masteredWords = [];
        
        // åˆå§‹æ•¸æ“š
        const initialWords = ["éƒ½æ˜¯", "æ¢", "é€™å€‹", "é‚£å€‹", "åˆæˆ", "å…¶é¤˜", "å…±æœ‰"];
        const initialMastered = ["å’Œ", "é«˜", "å–äº†"];

        let currentIndex = 0;
        let cantoneseVoice = null;
        
        // --- ç‹€æ…‹ç®¡ç† (ç²¾æº–æš«åœ) ---
        let state = {
            status: 'idle', // idle, countdown, speaking, paused
            timerId: null,
            countdownRemaining: 0,
            countdownCallback: null, // æš«åœå¾Œæ¢å¾©è¦åŸ·è¡Œçš„å‡½æ•¸
            countdownLabel: '',
            repeatCount: 0 // ç•¶å‰è®€äº†å¹¾æ¬¡
        };
        
        let shuffleDeck = [];
        let deleteMode = false;
        
        let settings = {
            autoDelay: 4,
            repeatDelay: 2,
            masteryThreshold: 1
        };

        function init() {
            // åˆå§‹åŒ–æ•¸æ“š
            words = initialWords.map(w => ({ text: w, views: 0, hits: 0 }));
            masteredWords = initialMastered.map(w => ({ text: w, views: 0, hits: 0 }));
            
            renderLists();
            updateCard();
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = selectVoice;
                selectVoice();
            }

            document.getElementById('autoPlayNext').addEventListener('change', (e) => {
                if (!e.target.checked) stopEverything();
                else if (words.length > 0) startSequence();
            });
            
            document.getElementById('randomOrder').addEventListener('change', () => {
                shuffleDeck = [];
            });
        }

        function selectVoice() {
            const voices = window.speechSynthesis.getVoices();
            cantoneseVoice = voices.find(v => v.lang === 'zh-HK' && v.name.includes('Google')) || 
                             voices.find(v => v.lang === 'zh-HK');
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæµç¨‹æ§åˆ¶ ---

        function stopEverything() {
            clearTimeout(state.timerId);
            clearInterval(state.timerId);
            window.speechSynthesis.cancel();
            state.status = 'idle';
            state.repeatCount = 0;
            updateStatusUI();
        }

        function toggleSpeak() {
            if (words.length === 0) return;

            if (state.status === 'paused') {
                // ç¹¼çºŒ
                resumeFlow();
            } else if (state.status === 'countdown' || state.status === 'speaking') {
                // æš«åœ
                pauseFlow();
            } else {
                // é–‹å§‹
                if (document.getElementById('autoPlayNext').checked) {
                    startSequence();
                } else {
                    // æ‰‹å‹•æ¨¡å¼ï¼Œç›´æ¥è®€
                    speakWordFlow();
                }
            }
        }

        function pauseFlow() {
            clearInterval(state.timerId);
            clearTimeout(state.timerId);
            window.speechSynthesis.cancel();
            state.status = 'paused';
            updateStatusUI();
        }

        function resumeFlow() {
            if (state.countdownCallback) {
                // å¦‚æœæ˜¯åœ¨å€’æ•¸ä¸­æš«åœï¼Œæ¢å¾©å€’æ•¸
                state.status = 'countdown';
                runCountdown(state.countdownRemaining, state.countdownLabel, state.countdownCallback);
            } else {
                // å¦‚æœæ˜¯åœ¨æœ—è®€ä¸­æš«åœï¼Œç›´æ¥é‡æ–°è®€é€™ä¸€æ¬¡
                speakWordFlow(); 
            }
            updateStatusUI();
        }

        function startSequence() {
            stopEverything();
            state.repeatCount = 0;
            // é–‹å§‹ä¸»å€’æ•¸
            runCountdown(settings.autoDelay, "è©¦ä¸‹è‡ªå·±è®€", () => {
                speakWordFlow();
            });
        }

        function runCountdown(seconds, text, callback) {
            state.status = 'countdown';
            state.countdownRemaining = seconds;
            state.countdownLabel = text;
            state.countdownCallback = callback;
            
            updateStatusUI(); // é¡¯ç¤ºåˆå§‹ç§’æ•¸

            state.timerId = setInterval(() => {
                state.countdownRemaining--;
                if (state.countdownRemaining > 0) {
                    updateStatusUI();
                } else {
                    clearInterval(state.timerId);
                    state.countdownCallback = null; // æ¸…é™¤ callback
                    callback();
                }
            }, 1000);
        }

        function speakWordFlow() {
            if (words.length === 0) return;
            
            state.status = 'speaking';
            state.countdownCallback = null; // æœ—è®€ä¸­æ²’æœ‰å€’æ•¸å›èª¿
            updateStatusUI();

            // å¢åŠ  Views (åªåœ¨ç¬¬ä¸€æ¬¡è®€æ™‚è¨ˆæ•¸ï¼Œé‡è¤‡è®€ä¸è¨ˆ)
            if (state.repeatCount === 0) {
                words[currentIndex].views++;
                renderLists(); 
            }

            const u = new SpeechSynthesisUtterance(words[currentIndex].text);
            u.lang = 'zh-HK';
            if (cantoneseVoice) u.voice = cantoneseVoice;
            u.rate = 0.8;

            u.onend = () => {
                if (state.status === 'paused') return;

                const repeatThree = document.getElementById('repeatThreeTimes').checked;
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡è¤‡ (0, 1, 2 å…±ä¸‰æ¬¡)
                if (repeatThree && state.repeatCount < 2) {
                    state.repeatCount++;
                    // é€²å…¥é‡è¤‡å€’æ•¸
                    runCountdown(settings.repeatDelay, "æº–å‚™å†è®€", () => {
                        speakWordFlow();
                    });
                } else {
                    // å®Œæˆæ‰€æœ‰æœ—è®€
                    state.status = 'idle';
                    state.repeatCount = 0;
                    updateStatusUI();
                    
                    if (document.getElementById('autoPlayNext').checked) {
                        state.timerId = setTimeout(nextWord, 1000);
                    }
                }
            };
            
            window.speechSynthesis.speak(u);
        }

        function updateStatusUI() {
            const badge = document.getElementById('statusBadge');
            const btn = document.getElementById('speakBtn');
            
            badge.className = 'status-badge';
            badge.style.opacity = '0';
            
            // æŒ‰éˆ•æ–‡å­—
            if (state.status === 'paused') {
                btn.innerHTML = "â–¶ï¸ ç¹¼çºŒ";
                btn.classList.add('paused');
                
                badge.textContent = `â¸ å·²æš«åœ`;
                badge.classList.add('status-paused');
                badge.style.opacity = '1';
            } else if (state.status === 'countdown') {
                btn.innerHTML = "â¸ æš«åœ";
                btn.classList.add('paused');
                
                badge.textContent = `${state.countdownLabel} (${state.countdownRemaining})`;
                badge.classList.add('status-waiting');
                badge.style.opacity = '1';
            } else if (state.status === 'speaking') {
                btn.innerHTML = "â¸ æš«åœ";
                btn.classList.add('paused');
                
                badge.textContent = 'ğŸ”Š è½ä¸‹è®€éŸ³';
                badge.classList.add('status-reading');
                badge.style.opacity = '1';
            } else {
                btn.innerHTML = "ğŸ”Š æœ—è®€";
                btn.classList.remove('paused');
            }
        }

        // --- åˆ—è¡¨æ¸²æŸ“ ---
        function renderLists() {
            const wordList = document.getElementById('wordList');
            const mList = document.getElementById('masteredList');
            
            document.getElementById('wordCount').textContent = `(${words.length})`;
            document.getElementById('masteredCount').textContent = `(${masteredWords.length})`;

            wordList.innerHTML = '';

            // 1. æ’å…¥ã€Œ+ã€æŒ‰éˆ• (Req: ç¬¬ä¸€æ ¼)
            const addBtn = document.createElement('div');
            addBtn.className = 'word-tag add-tag';
            addBtn.innerHTML = '<span>+</span>';
            addBtn.onclick = () => convertToAddInput(addBtn);
            wordList.appendChild(addBtn);

            // 2. æ’å…¥è©èª
            words.forEach((item, index) => {
                const tag = createTag(item, index, false);
                if (index === currentIndex) tag.classList.add('active');
                wordList.appendChild(tag);
            });

            // 3. æ’å…¥å·²å­¸è­˜
            mList.innerHTML = '';
            masteredWords.forEach((item, index) => {
                const tag = createTag(item, index, true);
                mList.appendChild(tag);
            });
        }

        function createTag(item, index, isMastered) {
            const div = document.createElement('div');
            div.className = 'word-tag';
            const word = item.text;
            
            // ç†Ÿç·´åº¦èƒŒæ™¯ (Req: ç¶ è‰²å¡«æ»¿)
            const pct = Math.min(100, (item.hits / settings.masteryThreshold) * 100);
            const bg = document.createElement('div');
            bg.className = 'word-tag-bg';
            bg.style.height = `${pct}%`;
            div.appendChild(bg);

            // å…§å®¹
            const content = document.createElement('div');
            content.className = 'word-tag-content';
            
            const len = word.length;
            if (len <= 2) div.classList.add('len-2');
            else if (len === 3) div.classList.add('len-3');
            else if (len === 4) div.classList.add('len-4');
            else div.classList.add('len-long');

            content.innerHTML = len === 4 
                ? `<span><i>${word.substring(0,2)}</i><i>${word.substring(2,4)}</i></span>`
                : `<span>${word}</span>`;
            
            div.appendChild(content);

            // Views è¨ˆæ•¸ (Req: å·¦ä¸‹è§’)
            const viewCount = document.createElement('div');
            viewCount.className = 'view-count';
            viewCount.textContent = item.views;
            div.appendChild(viewCount);

            if (isMastered) {
                handleMasteredInteraction(div, index, word);
            } else {
                handleWordListInteraction(div, index, item);
            }
            return div;
        }

        // --- äº¤äº’é‚è¼¯ ---

        function convertToAddInput(element) {
            element.innerHTML = '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'grid-input';
            input.placeholder = 'è¼¸å…¥';
            
            // è‡ªå‹•èšç„¦
            element.appendChild(input);
            input.focus();

            const save = () => {
                const val = input.value.trim();
                if (val) {
                    words.unshift({ text: val, views: 0, hits: 0 });
                    currentIndex = 0;
                    renderLists();
                    updateCard();
                } else {
                    renderLists(); // é‚„åŸ
                }
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur(); // è§¸ç™¼ save
                }
            });
        }

        function handleWordListInteraction(div, index, item) {
            // é»æ“Šï¼šåˆ‡æ›
            div.onclick = () => {
                if (state.status === 'idle' || state.status === 'paused') {
                    currentIndex = index;
                    updateCard();
                }
            };

            // é•·æŒ‰ï¼šç§»è‡³å·²å­¸è­˜ (Req: æ–°åŠŸèƒ½)
            let pressTimer;
            const startPress = () => {
                pressTimer = setTimeout(() => {
                    // ç›´æ¥ç§»å‹•
                    masteredWords.push(item);
                    words.splice(index, 1);
                    if (currentIndex >= words.length) currentIndex = 0;
                    
                    triggerSmallPop(div.getBoundingClientRect());
                    showToast(`å·²å°‡ã€Œ${item.text}ã€ç§»è‡³å·²å­¸è­˜`);
                    renderLists();
                    updateCard();
                }, 800);
            };
            const cancelPress = () => clearTimeout(pressTimer);

            div.addEventListener('touchstart', startPress);
            div.addEventListener('touchend', cancelPress);
            div.addEventListener('mousedown', startPress);
            div.addEventListener('mouseup', cancelPress);
        }

        function handleMasteredInteraction(div, index, word) {
            if (deleteMode) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'del-checkbox';
                checkbox.dataset.index = index;
                div.appendChild(checkbox);
                div.onclick = (e) => {
                    if(e.target !== checkbox) checkbox.checked = !checkbox.checked;
                };
            } else {
                // é•·æŒ‰é€²å…¥åˆªé™¤æ¨¡å¼
                let pressTimer;
                const startPress = () => { pressTimer = setTimeout(enterDeleteMode, 800); };
                const cancelPress = () => clearTimeout(pressTimer);
                
                div.addEventListener('touchstart', startPress);
                div.addEventListener('touchend', cancelPress);
                div.addEventListener('mousedown', startPress);
                div.addEventListener('mouseup', cancelPress);

                // é›™æ“Šé‚„åŸ
                div.ondblclick = () => {
                    masteredWords.splice(index, 1);
                    words.unshift({ text: word, views: 0, hits: 0 });
                    currentIndex = 0;
                    renderLists();
                    updateCard();
                };
            }
        }

        // --- åˆªé™¤æ¨¡å¼ ---
        function enterDeleteMode() {
            deleteMode = true;
            document.body.classList.add('delete-mode-active');
            document.getElementById('deleteControls').style.display = 'flex';
            renderLists();
            showToast("å·²é€²å…¥åˆªé™¤æ¨¡å¼");
        }

        function exitDeleteMode() {
            deleteMode = false;
            document.body.classList.remove('delete-mode-active');
            document.getElementById('deleteControls').style.display = 'none';
            renderLists();
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.del-checkbox');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        function confirmBatchDelete() {
            const checkboxes = document.querySelectorAll('.del-checkbox:checked');
            if (checkboxes.length === 0) return;
            
            const indices = Array.from(checkboxes).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            indices.forEach(idx => masteredWords.splice(idx, 1));
            
            showToast(`å·²åˆªé™¤ ${indices.length} å€‹è©èª`);
            exitDeleteMode();
        }

        // --- å°èˆªèˆ‡å­¸ç¿’ ---
        function updateCard() {
            const display = document.getElementById('currentWord');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (words.length === 0) {
                display.textContent = "åŠ å­—å…ˆï¼";
                display.style.fontSize = "3rem";
                document.getElementById('speakBtn').disabled = true;
                document.getElementById('masteredBtn').disabled = true;
                progressFill.style.width = `100%`;
                progressText.textContent = `å…¨éƒ¨å®Œæˆï¼`;
                renderLists();
                return;
            }

            document.getElementById('speakBtn').disabled = false;
            document.getElementById('masteredBtn').disabled = false;

            const item = words[currentIndex];
            display.textContent = item.text;
            display.style.fontSize = item.text.length > 3 ? "5rem" : "8rem";

            const pct = ((currentIndex + 1) / words.length) * 100;
            progressFill.style.width = `${pct}%`;
            progressText.textContent = `${currentIndex + 1} / ${words.length}`;

            renderLists();
        }

        function nextWord() {
            if (words.length === 0) return;
            stopEverything();

            if (document.getElementById('randomOrder').checked) {
                if (shuffleDeck.length === 0) {
                    shuffleDeck = words.map((_, i) => i).filter(i => i !== currentIndex);
                    if (shuffleDeck.length === 0 && words.length > 0) shuffleDeck = [0];
                    for (let i = shuffleDeck.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffleDeck[i], shuffleDeck[j]] = [shuffleDeck[j], shuffleDeck[i]];
                    }
                }
                currentIndex = shuffleDeck.pop();
            } else {
                currentIndex = (currentIndex + 1) % words.length;
            }
            updateCard();
            
            if (document.getElementById('autoPlayNext').checked) {
                startSequence();
            }
        }

        function previousWord() {
            if (words.length === 0) return;
            stopEverything();
            currentIndex = (currentIndex - 1 + words.length) % words.length;
            updateCard();
        }

        function handleMasteryClick(e) {
            if (words.length === 0) return;
            
            const item = words[currentIndex];
            item.hits++;
            
            // Req: å°ç‰¹æ•ˆ (æ˜Ÿæ˜Ÿ)
            triggerSmallPop(e.target.getBoundingClientRect());

            if (item.hits >= settings.masteryThreshold) {
                // çœŸæ­£å­¸è­˜
                masteredWords.push(item);
                words.splice(currentIndex, 1);
                
                if (words.length === 0) currentIndex = 0;
                else if (currentIndex >= words.length) currentIndex = 0;

                // Req: å¤§ç‰¹æ•ˆ (ç´™ç¢)
                triggerConfetti();
                showToast(`ğŸ‰ å¤ªæ£’äº†ï¼å­¸è­˜å’—ã€Œ${item.text}ã€`);
                
                renderLists();
                updateCard();
            } else {
                renderLists(); // æ›´æ–°èƒŒæ™¯é€²åº¦
            }
        }

        // --- è¨­ç½®èˆ‡å°å…¥ ---
        function openSettingsModal() {
            document.getElementById('settingAutoDelay').value = settings.autoDelay;
            document.getElementById('settingRepeatDelay').value = settings.repeatDelay;
            document.getElementById('settingMasteryThreshold').value = settings.masteryThreshold;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function saveSettings() {
            settings.autoDelay = parseInt(document.getElementById('settingAutoDelay').value) || 4;
            settings.repeatDelay = parseInt(document.getElementById('settingRepeatDelay').value) || 2;
            settings.masteryThreshold = parseInt(document.getElementById('settingMasteryThreshold').value) || 1;
            closeModal('settingsModal');
            showToast("è¨­å®šå·²ä¿å­˜");
            renderLists(); // æ›´æ–°é–¾å€¼ç›¸é—œçš„èƒŒæ™¯
        }

        function openEditModal() {
            const text = `ã€è©èªè¡¨ã€‘\n${words.map(w=>w.text).join('\n')}\n\nã€å·²å­¸è­˜ã€‘\n${masteredWords.map(w=>w.text).join('\n')}`;
            document.getElementById('importTextarea').value = text;
            document.getElementById('importModal').style.display = 'flex';
        }

        function saveEdit() {
            const raw = document.getElementById('importTextarea').value;
            if (!raw.trim()) { closeModal('importModal'); return; }
            const parts = raw.split('ã€å·²å­¸è­˜ã€‘');
            const part1 = parts[0].replace('ã€è©èªè¡¨ã€‘', '');
            const part2 = parts[1] || '';
            const parseLines = (txt) => txt.split(/[\n,]+/).map(w => w.trim()).filter(w => w);
            
            words = [...new Set(parseLines(part1))].map(w => ({ text: w, views: 0, hits: 0 }));
            masteredWords = [...new Set(parseLines(part2))].map(w => ({ text: w, views: 0, hits: 0 }));
            
            currentIndex = 0;
            renderLists();
            updateCard();
            closeModal('importModal');
            showToast("å·²æ›´æ–°åˆ—è¡¨");
        }

        function exportData() {
            const text = `ã€è©èªè¡¨ã€‘\n${words.map(w=>w.text).join('\n')}\n\nã€å·²å­¸è­˜ã€‘\n${masteredWords.map(w=>w.text).join('\n')}`;
            navigator.clipboard.writeText(text).then(() => showToast("å·²è¤‡è£½ï¼")).catch(() => showToast("è¤‡è£½å¤±æ•—"));
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }

        // --- ç‰¹æ•ˆ ---
        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            
            let particles = [];
            const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50'];

            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 10 + 5, h: Math.random() * 5 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vy: Math.random() * 3 + 2, vx: Math.random() * 2 - 1,
                    r: Math.random() * 360, vr: Math.random() * 10 - 5
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    p.y += p.vy; p.x += Math.sin(p.y * 0.01) + p.vx; p.r += p.vr;
                    if (p.y < canvas.height) {
                        active = true;
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r * Math.PI / 180);
                        ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                    }
                });
                if (active) requestAnimationFrame(animate);
            }
            animate();
        }

        function triggerSmallPop(rect) {
            // ç°¡å–®çš„å°æ˜Ÿæ˜Ÿç‰¹æ•ˆ
            const count = 8;
            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.textContent = 'â­';
                p.style.position = 'absolute';
                p.style.left = (rect.left + rect.width/2) + 'px';
                p.style.top = (rect.top + rect.height/2) + 'px';
                p.style.fontSize = '1.5rem';
                p.style.pointerEvents = 'none';
                p.style.transition = 'all 0.8s ease-out';
                p.style.zIndex = 5000;
                document.body.appendChild(p);
                
                const angle = (i / count) * 2 * Math.PI;
                const dist = 50;
                
                requestAnimationFrame(() => {
                    p.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist - 50}px) scale(0)`;
                    p.style.opacity = 0;
                });
                setTimeout(() => p.remove(), 800);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
